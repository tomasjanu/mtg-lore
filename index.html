<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <!-- MTG Lore Translator v1.0 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Lore ‚Äì P≈ôeklad do ƒçe≈°tiny</title>
    <style>
        :root {
            --bg-primary: #0d0d1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f3460;
            --text-primary: #e0d8c8;
            --text-secondary: #a89f91;
            --accent-gold: #c9a84c;
            --accent-gold-dim: #8a7333;
            --accent-purple: #7b2d8e;
            --accent-red: #c0392b;
            --accent-green: #27ae60;
            --border: #2a2a4a;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        #app {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0 20px;
            border-bottom: 2px solid var(--accent-gold-dim);
            margin-bottom: 30px;
        }

        header h1 {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 2.2rem;
            color: var(--accent-gold);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        header p {
            color: var(--text-secondary);
            margin-top: 6px;
            font-size: 0.95rem;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 10px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-gold {
            background: var(--accent-gold);
            color: #1a1a2e;
        }

        .btn-gold:hover {
            background: #d4b65c;
            transform: translateY(-1px);
        }

        .btn-gold:disabled {
            background: var(--accent-gold-dim);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #1a4a80;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #e74c3c;
        }

        .btn-small {
            padding: 6px 14px;
            font-size: 0.85rem;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .toolbar h2 {
            font-family: Georgia, serif;
            color: var(--accent-gold);
            font-size: 1.4rem;
        }

        /* Article cards */
        .article-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 18px 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .article-card:hover {
            border-color: var(--accent-gold-dim);
            transform: translateX(4px);
            box-shadow: 0 2px 12px var(--shadow);
        }

        .article-card-info {
            flex: 1;
            min-width: 0;
        }

        .article-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .article-card-meta {
            font-size: 0.82rem;
            color: var(--text-secondary);
        }

        .article-card-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-translated {
            background: var(--accent-green);
            color: white;
        }

        .status-original {
            background: var(--accent-gold-dim);
            color: var(--text-primary);
        }

        .status-translating {
            background: var(--accent-purple);
            color: white;
        }

        /* Empty state */
        #empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        #empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        #empty-state p {
            margin-bottom: 20px;
            font-size: 1.05rem;
        }

        /* Form */
        .form-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: var(--accent-gold);
            margin-bottom: 16px;
            font-family: Georgia, serif;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-group select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-row .btn {
            margin-bottom: 18px;
            white-space: nowrap;
        }

        .separator {
            text-align: center;
            color: var(--text-secondary);
            margin: 20px 0;
            font-size: 0.9rem;
            position: relative;
        }

        .separator::before,
        .separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .separator::before { left: 0; }
        .separator::after { right: 0; }

        /* Progress */
        .progress-area {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-gold));
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Preview */
        .preview-box {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        /* Read view */
        .read-header {
            margin-bottom: 24px;
        }

        .read-header h2 {
            font-family: Georgia, serif;
            font-size: 1.8rem;
            color: var(--accent-gold);
            margin: 16px 0 8px;
            line-height: 1.3;
        }

        .read-meta {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        .read-meta a {
            color: var(--accent-gold-dim);
            text-decoration: none;
        }

        .read-meta a:hover {
            color: var(--accent-gold);
            text-decoration: underline;
        }

        .toggle-group {
            display: flex;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 24px;
            width: fit-content;
        }

        .toggle-btn {
            padding: 8px 20px;
            background: var(--bg-card);
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-gold);
            color: #1a1a2e;
        }

        .toggle-btn:not(.active):hover {
            background: var(--bg-input);
        }

        .read-content {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .read-content p {
            margin-bottom: 1.2em;
            text-align: justify;
        }

        .read-content h1,
        .read-content h2,
        .read-content h3 {
            font-family: Georgia, serif;
            color: var(--accent-gold);
            margin: 1.5em 0 0.6em;
        }

        .read-content em {
            color: #d4c5a0;
        }

        .read-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2em 0;
        }

        /* Alert / notification */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .alert-error {
            background: rgba(192, 57, 43, 0.2);
            border: 1px solid var(--accent-red);
            color: #e74c3c;
        }

        .alert-info {
            background: rgba(123, 45, 142, 0.15);
            border: 1px solid var(--accent-purple);
            color: #bb86fc;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.15);
            border: 1px solid var(--accent-green);
            color: #2ecc71;
        }

        /* Sections */
        section {
            display: none;
        }

        section.active {
            display: block;
        }

        /* Settings row */
        .settings-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .settings-row .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 200px;
        }

        /* Google Translate link */
        .translate-fallback {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .translate-fallback a {
            color: var(--accent-gold);
        }

        /* Responsive */
        @media (max-width: 600px) {
            #app { padding: 12px; }
            header h1 { font-size: 1.5rem; }
            .form-row { flex-direction: column; }
            .form-row .btn { margin-bottom: 0; }
            .article-card { flex-direction: column; align-items: flex-start; }
            .article-card-actions { margin-left: 0; margin-top: 10px; }
            .read-content { font-size: 1rem; }
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-secondary);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Confirm dialog */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal-box p {
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>MTG Lore Translator</h1>
            <p>Magic: The Gathering ‚Äì p≈ô√≠bƒõhy v ƒçe≈°tinƒõ</p>
        </header>

        <div id="alert-area"></div>

        <!-- Library View -->
        <section id="library-view" class="active">
            <div class="toolbar">
                <h2>Knihovna p≈ô√≠bƒõh≈Ø</h2>
                <button class="btn btn-gold" onclick="showView('add-view')">+ P≈ôidat p≈ô√≠bƒõh</button>
            </div>
            <div id="article-list"></div>
            <div id="empty-state">
                <div class="icon">üìú</div>
                <p>Zat√≠m nem√°te ≈æ√°dn√© p≈ô√≠bƒõhy.<br>P≈ôidejte sv≈Øj prvn√≠ MTG p≈ô√≠bƒõh k p≈ôeƒçten√≠ v ƒçe≈°tinƒõ.</p>
                <button class="btn btn-gold" onclick="showView('add-view')">+ P≈ôidat p≈ô√≠bƒõh</button>
            </div>
        </section>

        <!-- Add Article View -->
        <section id="add-view">
            <div class="toolbar">
                <h2>P≈ôidat nov√Ω p≈ô√≠bƒõh</h2>
                <button class="btn btn-secondary btn-small" onclick="showView('library-view')">Zpƒõt</button>
            </div>

            <div class="form-section">
                <h3>Mo≈ænost 1: Naƒç√≠st z URL</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>URL p≈ô√≠bƒõhu z magic.wizards.com</label>
                        <input type="url" id="url-input"
                               placeholder="https://magic.wizards.com/en/news/magic-story/...">
                    </div>
                    <button class="btn btn-secondary" id="fetch-btn" onclick="fetchArticle()">Naƒç√≠st</button>
                </div>
            </div>

            <div class="separator">nebo</div>

            <div class="form-section">
                <h3>Mo≈ænost 2: Vlo≈æit text ruƒçnƒõ</h3>
                <div class="form-group">
                    <label>Zkop√≠rujte a vlo≈æte anglick√Ω text p≈ô√≠bƒõhu</label>
                    <textarea id="paste-input"
                              placeholder="Vlo≈æte sem anglick√Ω text p≈ô√≠bƒõhu z webu..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <h3>Nastaven√≠</h3>
                <div class="form-group">
                    <label>N√°zev p≈ô√≠bƒõhu</label>
                    <input type="text" id="title-input"
                           placeholder="N√°zev p≈ô√≠bƒõhu (vypln√≠ se automaticky p≈ôi naƒçten√≠ z URL)">
                </div>
                <div class="form-group">
                    <label>P≈ôekladov√Ω engine</label>
                    <select id="engine-select" onchange="onEngineChange()">
                        <option value="openai">OpenAI (gpt-4o-mini) ‚Äì nejlep≈°√≠ kvalita</option>
                        <option value="mymemory">MyMemory ‚Äì zdarma, ni≈æ≈°√≠ kvalita</option>
                    </select>
                </div>
                <div id="openai-settings">
                    <div class="form-group">
                        <label>OpenAI API kl√≠ƒç</label>
                        <input type="password" id="apikey-input"
                               placeholder="sk-...">
                        <small style="color:var(--text-secondary);font-size:0.8rem;">
                            Kl√≠ƒç se ukl√°d√° pouze ve va≈°em prohl√≠≈æeƒçi (localStorage). Z√≠skejte na
                            <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener"
                               style="color:var(--accent-gold)">platform.openai.com/api-keys</a>
                        </small>
                    </div>
                </div>
                <div id="mymemory-settings" style="display:none">
                    <div class="form-group">
                        <label>E-mail pro vy≈°≈°√≠ limit p≈ôekladu (voliteln√©, zv√Ω≈°√≠ denn√≠ limit z 5 000 na 50 000 znak≈Ø)</label>
                        <input type="email" id="email-input"
                               placeholder="vas@email.com">
                    </div>
                </div>
            </div>

            <div id="preview-area" style="display:none">
                <div class="form-section">
                    <h3>N√°hled naƒçten√©ho obsahu</h3>
                    <div class="preview-box" id="preview-content"></div>
                </div>
            </div>

            <div id="progress-area" style="display:none" class="progress-area">
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <span class="progress-text" id="progress-text"></span>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <button class="btn btn-gold" id="translate-btn" onclick="translateAndSave()">P≈ôelo≈æit a ulo≈æit</button>
                <button class="btn btn-secondary" id="save-original-btn" onclick="saveOriginalOnly()">Ulo≈æit bez p≈ôekladu</button>
            </div>
        </section>

        <!-- Read View -->
        <section id="read-view">
            <div class="read-header">
                <button class="btn btn-secondary btn-small" onclick="showView('library-view')">‚Üê Zpƒõt do knihovny</button>
                <h2 id="read-title"></h2>
                <div class="read-meta" id="read-meta"></div>
            </div>
            <div class="toggle-group" id="lang-toggle">
                <button class="toggle-btn active" data-lang="cs" onclick="switchLang('cs')">ƒåesky</button>
                <button class="toggle-btn" data-lang="en" onclick="switchLang('en')">English</button>
            </div>
            <div class="read-content" id="read-content"></div>
            <div class="translate-fallback" id="translate-fallback" style="display:none">
                <strong>ƒål√°nek nebyl p≈ôelo≈æen.</strong>
                M≈Ø≈æete jej p≈ôelo≈æit p≈ô√≠mo:
                <a id="google-translate-link" href="#" target="_blank" rel="noopener">
                    Otev≈ô√≠t v Google Translate
                </a>
            </div>
        </section>
    </div>

    <script>
    (function() {
        'use strict';

        const STORAGE_KEY = 'mtg-lore-articles';
        const EMAIL_KEY = 'mtg-lore-email';
        const APIKEY_KEY = 'mtg-lore-openai-key';
        const ENGINE_KEY = 'mtg-lore-engine';

        // CORS proxies to try in order
        const CORS_PROXIES = [
            url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
        ];

        let currentReadId = null;
        let translationAborted = false;

        // ‚îÄ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadArticles() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch {
                return [];
            }
        }

        function saveArticles(articles) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(articles));
        }

        function loadEmail() {
            return localStorage.getItem(EMAIL_KEY) || '';
        }

        function saveEmail(email) {
            localStorage.setItem(EMAIL_KEY, email);
        }

        function loadApiKey() {
            return localStorage.getItem(APIKEY_KEY) || '';
        }

        function saveApiKey(key) {
            localStorage.setItem(APIKEY_KEY, key);
        }

        function loadEngine() {
            return localStorage.getItem(ENGINE_KEY) || 'openai';
        }

        function saveEngine(engine) {
            localStorage.setItem(ENGINE_KEY, engine);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        }

        // ‚îÄ‚îÄ‚îÄ Engine selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.onEngineChange = function() {
            const engine = document.getElementById('engine-select').value;
            document.getElementById('openai-settings').style.display = engine === 'openai' ? 'block' : 'none';
            document.getElementById('mymemory-settings').style.display = engine === 'mymemory' ? 'block' : 'none';
            saveEngine(engine);
        };

        // ‚îÄ‚îÄ‚îÄ View management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.showView = function(viewId) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            clearAlert();
            if (viewId === 'library-view') renderLibrary();
            if (viewId === 'add-view') {
                document.getElementById('email-input').value = loadEmail();
                document.getElementById('apikey-input').value = loadApiKey();
                const engine = loadEngine();
                document.getElementById('engine-select').value = engine;
                onEngineChange();
            }
            window.scrollTo(0, 0);
        };

        // ‚îÄ‚îÄ‚îÄ Alert messages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showAlert(msg, type = 'error') {
            const area = document.getElementById('alert-area');
            area.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            window.scrollTo(0, 0);
        }

        function clearAlert() {
            document.getElementById('alert-area').innerHTML = '';
        }

        // ‚îÄ‚îÄ‚îÄ Library rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderLibrary() {
            const articles = loadArticles();
            const listEl = document.getElementById('article-list');
            const emptyEl = document.getElementById('empty-state');

            if (articles.length === 0) {
                listEl.innerHTML = '';
                emptyEl.style.display = 'block';
                return;
            }

            emptyEl.style.display = 'none';
            listEl.innerHTML = articles.map(a => {
                const date = new Date(a.dateAdded).toLocaleDateString('cs-CZ');
                const statusClass = a.translatedContent ? 'status-translated' : 'status-original';
                const statusText = a.translatedContent ? 'P≈ôelo≈æeno' : 'Pouze origin√°l';
                return `
                    <div class="article-card" onclick="openArticle('${a.id}')">
                        <div class="article-card-info">
                            <div class="article-card-title">${escapeHtml(a.title)}</div>
                            <div class="article-card-meta">
                                ${date} &nbsp;
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="article-card-actions">
                            ${!a.translatedContent ?
                                `<button class="btn btn-gold btn-small" onclick="event.stopPropagation(); retranslateArticle('${a.id}')">P≈ôelo≈æit</button>` : ''}
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteArticle('${a.id}')">Smazat</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ Open article for reading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.openArticle = function(id) {
            const articles = loadArticles();
            const article = articles.find(a => a.id === id);
            if (!article) return;

            currentReadId = id;
            document.getElementById('read-title').textContent = article.title;

            const date = new Date(article.dateAdded).toLocaleDateString('cs-CZ');
            let metaHtml = `P≈ôid√°no: ${date}`;
            if (article.url) {
                metaHtml += ` &bull; <a href="${escapeHtml(article.url)}" target="_blank" rel="noopener">Origin√°ln√≠ ƒçl√°nek</a>`;
            }
            document.getElementById('read-meta').innerHTML = metaHtml;

            // Set up language toggle
            const langToggle = document.getElementById('lang-toggle');
            const fallback = document.getElementById('translate-fallback');

            if (article.translatedContent) {
                langToggle.style.display = 'flex';
                fallback.style.display = 'none';
                switchLang('cs');
            } else {
                langToggle.style.display = 'none';
                showReadContent(article.originalContent);
                // Show Google Translate fallback
                if (article.url) {
                    fallback.style.display = 'block';
                    document.getElementById('google-translate-link').href =
                        `https://translate.google.com/translate?sl=en&tl=cs&u=${encodeURIComponent(article.url)}`;
                } else {
                    fallback.style.display = 'block';
                    document.getElementById('google-translate-link').href =
                        `https://translate.google.com/?sl=en&tl=cs&text=${encodeURIComponent(article.originalContent.slice(0, 5000))}`;
                }
            }

            showView('read-view');
        };

        window.switchLang = function(lang) {
            const articles = loadArticles();
            const article = articles.find(a => a.id === currentReadId);
            if (!article) return;

            document.querySelectorAll('.toggle-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.lang === lang);
            });

            const content = lang === 'cs' ? article.translatedContent : article.originalContent;
            showReadContent(content);
        };

        function showReadContent(text) {
            const el = document.getElementById('read-content');
            // Convert text to paragraphs
            const paragraphs = text.split(/\n\n+/).filter(p => p.trim());
            el.innerHTML = paragraphs.map(p => {
                const trimmed = p.trim();
                // Detect separator lines
                if (/^[*\-_=~]{3,}$/.test(trimmed)) {
                    return '<hr>';
                }
                // Detect headings
                if (trimmed.startsWith('# ')) {
                    return `<h2>${escapeHtml(trimmed.slice(2))}</h2>`;
                }
                return `<p>${escapeHtml(trimmed)}</p>`;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ Delete article ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.deleteArticle = function(id) {
            if (!confirm('Opravdu chcete smazat tento p≈ô√≠bƒõh?')) return;
            const articles = loadArticles().filter(a => a.id !== id);
            saveArticles(articles);
            renderLibrary();
        };

        // ‚îÄ‚îÄ‚îÄ Retranslate from library ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.retranslateArticle = async function(id) {
            const articles = loadArticles();
            const article = articles.find(a => a.id === id);
            if (!article) return;

            // Prefill the add view
            document.getElementById('title-input').value = article.title;
            document.getElementById('paste-input').value = article.originalContent;
            document.getElementById('url-input').value = article.url || '';
            showView('add-view');
            showAlert('Obsah naƒçten ‚Äì kliknƒõte na "P≈ôelo≈æit a ulo≈æit" pro p≈ôeklad.', 'info');

            // Remove old entry so the translate function creates a new one
            const remaining = articles.filter(a => a.id !== id);
            saveArticles(remaining);
        };

        // ‚îÄ‚îÄ‚îÄ Fetch article from URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.fetchArticle = async function() {
            const url = document.getElementById('url-input').value.trim();
            if (!url) {
                showAlert('Zadejte URL p≈ô√≠bƒõhu.');
                return;
            }

            const fetchBtn = document.getElementById('fetch-btn');
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<span class="spinner"></span>Naƒç√≠t√°m...';
            clearAlert();

            try {
                const html = await fetchWithProxy(url);
                const { title, content } = parseArticleHtml(html, url);

                if (!content || content.length < 50) {
                    throw new Error('Nepoda≈ôilo se extrahovat obsah ƒçl√°nku. Zkuste vlo≈æit text ruƒçnƒõ (Mo≈ænost 2).');
                }

                document.getElementById('title-input').value = title || '';
                document.getElementById('paste-input').value = content;

                // Show preview
                const previewArea = document.getElementById('preview-area');
                const previewContent = document.getElementById('preview-content');
                previewArea.style.display = 'block';
                previewContent.textContent = content.slice(0, 1000) + (content.length > 1000 ? '...' : '');

                showAlert(`Obsah √∫spƒõ≈°nƒõ naƒçten (${content.length} znak≈Ø). Zkontrolujte n√°hled a kliknƒõte na "P≈ôelo≈æit a ulo≈æit".`, 'success');
            } catch (err) {
                showAlert(`Chyba p≈ôi naƒç√≠t√°n√≠: ${err.message}`);
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'Naƒç√≠st';
            }
        };

        async function fetchWithProxy(url) {
            let lastError;
            for (const makeProxy of CORS_PROXIES) {
                try {
                    const proxyUrl = makeProxy(url);
                    const resp = await fetch(proxyUrl, {
                        headers: { 'Accept': 'text/html' }
                    });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    return await resp.text();
                } catch (err) {
                    lastError = err;
                }
            }
            throw new Error(
                'V≈°echny CORS proxy selhaly. Zkuste zkop√≠rovat text p≈ô√≠bƒõhu ruƒçnƒõ z prohl√≠≈æeƒçe ' +
                'a vlo≈æit jej do pole "Mo≈ænost 2". ' +
                `(Posledn√≠ chyba: ${lastError.message})`
            );
        }

        function parseArticleHtml(html, url) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            let title = '';
            let content = '';

            // Remove unwanted elements
            doc.querySelectorAll('script, style, nav, footer, aside, iframe, .ad, [role="navigation"]')
                .forEach(el => el.remove());

            // Try new MTG site structure
            const articleBody = doc.querySelector('#article-body');
            if (articleBody) {
                // Remove sidebar elements
                articleBody.querySelectorAll('aside, div[class*="sidebar"]').forEach(el => el.remove());

                const headerEl = articleBody.querySelector('article header h1') ||
                                  articleBody.querySelector('h1');
                if (headerEl) title = headerEl.textContent.trim();

                const articleEl = articleBody.querySelector('article') || articleBody;
                content = extractTextContent(articleEl);
            }

            // Try old structure
            if (!content || content.length < 100) {
                const mainContent = doc.querySelector('#main-content');
                if (mainContent) {
                    const titleEl = mainContent.querySelector('h1');
                    if (titleEl) title = titleEl.textContent.trim();

                    const articleEl = mainContent.querySelector('article') || mainContent;
                    content = extractTextContent(articleEl);
                }
            }

            // Generic fallback
            if (!content || content.length < 100) {
                const candidates = [
                    doc.querySelector('article'),
                    doc.querySelector('[role="main"]'),
                    doc.querySelector('main'),
                    doc.querySelector('.article-content'),
                    doc.querySelector('.story-content'),
                    doc.querySelector('.entry-content'),
                    doc.querySelector('.post-content')
                ].filter(Boolean);

                for (const el of candidates) {
                    const text = extractTextContent(el);
                    if (text.length > (content?.length || 0)) {
                        content = text;
                    }
                }

                if (!title) {
                    const titleEl = doc.querySelector('h1') || doc.querySelector('title');
                    if (titleEl) title = titleEl.textContent.trim();
                }
            }

            // Last resort: get title from URL
            if (!title) {
                title = url.split('/').pop().replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            }

            return { title, content: content?.trim() || '' };
        }

        function extractTextContent(element) {
            if (!element) return '';
            const blocks = [];
            const blockTags = new Set(['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI', 'BLOCKQUOTE', 'DIV', 'SECTION']);

            function walk(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent.trim();
                    if (text) blocks.push(text);
                    return;
                }
                if (node.nodeType !== Node.ELEMENT_NODE) return;

                const tag = node.tagName;
                // Skip unwanted tags
                if (['SCRIPT', 'STYLE', 'NAV', 'BUTTON', 'SVG', 'FIGURE', 'FIGCAPTION'].includes(tag)) return;

                if (tag === 'BR') {
                    blocks.push('\n');
                    return;
                }

                const isBlock = blockTags.has(tag);
                if (isBlock && tag.startsWith('H')) {
                    blocks.push('\n\n# ' + node.textContent.trim());
                    return;
                }
                if (tag === 'HR') {
                    blocks.push('\n\n---\n\n');
                    return;
                }

                if (isBlock) blocks.push('\n\n');
                for (const child of node.childNodes) {
                    walk(child);
                }
                if (isBlock) blocks.push('\n\n');
            }

            walk(element);

            // Clean up excessive newlines
            return blocks.join('')
                .replace(/\n{3,}/g, '\n\n')
                .replace(/^\n+|\n+$/g, '')
                .trim();
        }

        // ‚îÄ‚îÄ‚îÄ Translation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.translateAndSave = async function() {
            const originalText = document.getElementById('paste-input').value.trim();
            const title = document.getElementById('title-input').value.trim();
            const url = document.getElementById('url-input').value.trim();
            const engine = document.getElementById('engine-select').value;

            if (!originalText) {
                showAlert('Zadejte nebo naƒçtƒõte text p≈ô√≠bƒõhu k p≈ôekladu.');
                return;
            }
            if (!title) {
                showAlert('Zadejte n√°zev p≈ô√≠bƒõhu.');
                return;
            }

            // Validate engine settings
            if (engine === 'openai') {
                const apiKey = document.getElementById('apikey-input').value.trim();
                if (!apiKey) {
                    showAlert('Zadejte OpenAI API kl√≠ƒç pro p≈ôeklad.');
                    return;
                }
                saveApiKey(apiKey);
            } else {
                const email = document.getElementById('email-input').value.trim();
                if (email) saveEmail(email);
            }

            const translateBtn = document.getElementById('translate-btn');
            const saveBtn = document.getElementById('save-original-btn');
            translateBtn.disabled = true;
            saveBtn.disabled = true;
            translateBtn.innerHTML = '<span class="spinner"></span>P≈ôekl√°d√°m...';
            translationAborted = false;

            const progressArea = document.getElementById('progress-area');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            progressArea.style.display = 'block';

            try {
                let translatedContent;

                if (engine === 'openai') {
                    translatedContent = await translateWithOpenAi(originalText, progressFill, progressText);
                } else {
                    translatedContent = await translateWithMyMemory(originalText, progressFill, progressText);
                }

                // Save article
                const articles = loadArticles();
                articles.unshift({
                    id: generateId(),
                    title,
                    url,
                    originalContent: originalText,
                    translatedContent,
                    dateAdded: new Date().toISOString()
                });
                saveArticles(articles);

                // Reset form
                resetAddForm();
                showAlert('P≈ô√≠bƒõh √∫spƒõ≈°nƒõ p≈ôelo≈æen a ulo≈æen!', 'success');
                showView('library-view');
            } catch (err) {
                showAlert(`Chyba p≈ôi p≈ôekladu: ${err.message}. M≈Ø≈æete ulo≈æit p≈ô√≠bƒõh bez p≈ôekladu a p≈ôelo≈æit pozdƒõji.`);
            } finally {
                translateBtn.disabled = false;
                saveBtn.disabled = false;
                translateBtn.textContent = 'P≈ôelo≈æit a ulo≈æit';
                progressArea.style.display = 'none';
                progressFill.style.width = '0%';
            }
        };

        // ‚îÄ‚îÄ‚îÄ OpenAI Translation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const OPENAI_SYSTEM_PROMPT = `You are a professional literary translator specializing in fantasy fiction. Translate the following English text into Czech.

Rules:
- Produce natural, fluent Czech suitable for a fantasy novel
- Preserve the original tone, style, and voice of the author
- Keep proper nouns (character names, place names) in their original English form unless they have an established Czech translation
- Preserve paragraph structure exactly ‚Äì each input paragraph should map to one output paragraph
- Preserve any markdown formatting (headings starting with #, separators like ---)
- Do NOT add any commentary, notes, or explanations ‚Äì output ONLY the translated text
- Use appropriate Czech literary register, not colloquial language`;

        async function translateWithOpenAi(text, progressFill, progressText) {
            const apiKey = document.getElementById('apikey-input').value.trim();

            // Split text into batches of paragraphs (~3000 chars each for good context)
            const paragraphs = text.split(/\n\n+/).filter(p => p.trim());
            const MAX_BATCH_CHARS = 3000;
            const batches = [];
            let currentBatch = [];
            let currentLen = 0;

            for (const para of paragraphs) {
                if (currentLen + para.length > MAX_BATCH_CHARS && currentBatch.length > 0) {
                    batches.push(currentBatch.join('\n\n'));
                    currentBatch = [para];
                    currentLen = para.length;
                } else {
                    currentBatch.push(para);
                    currentLen += para.length;
                }
            }
            if (currentBatch.length > 0) batches.push(currentBatch.join('\n\n'));

            const translatedBatches = [];
            for (let i = 0; i < batches.length; i++) {
                if (translationAborted) break;

                const pct = Math.round(((i) / batches.length) * 100);
                progressFill.style.width = pct + '%';
                progressText.textContent = `P≈ôekl√°d√°m ƒç√°st ${i + 1} / ${batches.length} (${pct}%)...`;

                const translated = await callOpenAi(batches[i], apiKey);
                translatedBatches.push(translated);
            }

            progressFill.style.width = '100%';
            progressText.textContent = 'P≈ôeklad dokonƒçen!';
            return translatedBatches.join('\n\n');
        }

        async function callOpenAi(text, apiKey) {
            const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'system', content: OPENAI_SYSTEM_PROMPT },
                        { role: 'user', content: text }
                    ],
                    temperature: 0.3
                })
            });

            if (!resp.ok) {
                const err = await resp.json().catch(() => ({}));
                if (resp.status === 401) {
                    throw new Error('Neplatn√Ω OpenAI API kl√≠ƒç. Zkontrolujte kl√≠ƒç v nastaven√≠.');
                }
                if (resp.status === 429) {
                    throw new Error('P≈ôekroƒçen limit OpenAI API. Zkuste to za chv√≠li znovu.');
                }
                throw new Error(`OpenAI API chyba: ${err.error?.message || `HTTP ${resp.status}`}`);
            }

            const data = await resp.json();
            const content = data.choices?.[0]?.message?.content;
            if (!content) throw new Error('Pr√°zdn√° odpovƒõƒè z OpenAI.');
            return content.trim();
        }

        // ‚îÄ‚îÄ‚îÄ MyMemory Translation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function translateWithMyMemory(text, progressFill, progressText) {
            const email = document.getElementById('email-input').value.trim();
            const paragraphs = text.split(/\n\n+/).filter(p => p.trim());
            const translated = [];
            let totalChars = text.length;
            let doneChars = 0;

            for (let i = 0; i < paragraphs.length; i++) {
                if (translationAborted) break;

                const para = paragraphs[i].trim();
                if (!para) { translated.push(''); continue; }

                if (/^[*\-_=~#]{1,5}\s*$/.test(para) || para === '---') {
                    translated.push(para);
                    doneChars += para.length;
                    continue;
                }

                const translatedPara = await translateTextMyMemory(para, email);
                translated.push(translatedPara);

                doneChars += para.length;
                const pct = Math.round((doneChars / totalChars) * 100);
                progressFill.style.width = pct + '%';
                progressText.textContent = `P≈ôelo≈æeno ${i + 1} / ${paragraphs.length} odstavc≈Ø (${pct}%)`;

                if (i < paragraphs.length - 1) await sleep(300);
            }

            return translated.join('\n\n');
        }

        async function translateTextMyMemory(text, email) {
            const MAX_CHUNK = 480;
            if (text.length <= MAX_CHUNK) {
                return await callMyMemoryApi(text, email);
            }

            const sentences = text.match(/[^.!?]+[.!?]+\s*/g) || [text];
            const chunks = [];
            let current = '';

            for (const sentence of sentences) {
                if ((current + sentence).length > MAX_CHUNK && current) {
                    chunks.push(current.trim());
                    current = sentence;
                } else {
                    current += sentence;
                }
            }
            if (current.trim()) chunks.push(current.trim());

            const results = [];
            for (const chunk of chunks) {
                const result = await callMyMemoryApi(chunk, email);
                results.push(result);
                if (chunks.length > 1) await sleep(200);
            }

            return results.join(' ');
        }

        async function callMyMemoryApi(text, email) {
            const params = new URLSearchParams({ q: text, langpair: 'en|cs' });
            if (email) params.set('de', email);

            const resp = await fetch(`https://api.mymemory.translated.net/get?${params}`);
            if (!resp.ok) throw new Error(`Translation API error: HTTP ${resp.status}`);

            const data = await resp.json();
            if (data.responseStatus === 403) {
                throw new Error('Denn√≠ limit p≈ôekladu byl vyƒçerp√°n. Zkuste zadat e-mail pro vy≈°≈°√≠ limit, nebo pou≈æijte OpenAI engine.');
            }

            const translated = data.responseData?.translatedText;
            if (!translated) throw new Error('Pr√°zdn√° odpovƒõƒè z p≈ôekladu.');
            return translated;
        }

        // ‚îÄ‚îÄ‚îÄ Save without translation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.saveOriginalOnly = function() {
            const originalText = document.getElementById('paste-input').value.trim();
            const title = document.getElementById('title-input').value.trim();
            const url = document.getElementById('url-input').value.trim();

            if (!originalText) {
                showAlert('Zadejte nebo naƒçtƒõte text p≈ô√≠bƒõhu.');
                return;
            }
            if (!title) {
                showAlert('Zadejte n√°zev p≈ô√≠bƒõhu.');
                return;
            }

            const articles = loadArticles();
            articles.unshift({
                id: generateId(),
                title,
                url,
                originalContent: originalText,
                translatedContent: '',
                dateAdded: new Date().toISOString()
            });
            saveArticles(articles);

            resetAddForm();
            showAlert('P≈ô√≠bƒõh ulo≈æen (bez p≈ôekladu). M≈Ø≈æete jej p≈ôelo≈æit pozdƒõji z knihovny.', 'success');
            showView('library-view');
        };

        function resetAddForm() {
            document.getElementById('url-input').value = '';
            document.getElementById('paste-input').value = '';
            document.getElementById('title-input').value = '';
            document.getElementById('preview-area').style.display = 'none';
            document.getElementById('progress-area').style.display = 'none';
        }

        // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function escapeHtml(str) {
            const el = document.createElement('span');
            el.textContent = str;
            return el.innerHTML;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        renderLibrary();
    })();
    </script>
</body>
</html>
